<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#Cfff04" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <link rel="manifest" href="/manifest.json" />
    <title>BURN</title>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          //registering of serviceWorker.
          navigator.serviceWorker
            .register('./service-worker-v2.js')
            .then((reg) => console.log('Success:', reg.scope))
            .catch((err) => console.log('Failure: ', err));
        });
        // This variable will save the event for later use.
        window.installEvent;
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          installEvent = e;
        });
      }
    </script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-S2H7D2Z5LC"
    ></script>
    <script>
      if (!location.href.includes('localhost')) {
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-S2H7D2Z5LC');
      }
    </script>
  </head>

  <body>
    <div id="errorMsg">
      <p
        style="
          height: 80vh;
          font-size: x-large;
          color: gray;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          width: 80vw;
          margin: auto;
        "
      >
        In case if its not loading. Please call us on
        <a href="tel:+918754791569">+91 8754791569</a>
      </p>
    </div>
    <div id="root"></div>
    <script type="module" src="/src/web/main.tsx"></script>
  </body>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;500;600;700;800;1000&display=swap"
    rel="stylesheet"
  />
  <script>
    const getUser = () => {
      return new Promise((res, rej) => {
        var r = window.indexedDB.open('firebaseLocalStorageDb');

        r.onerror = function (event) {
          console.error('Error opening database:', event.target.errorCode);
        };

        r.onsuccess = function (event) {
          try {
            var db = event.target.result;

            var transaction = db.transaction(
              ['firebaseLocalStorage'],
              'readonly'
            );
            var objectStore = transaction.objectStore('firebaseLocalStorage');

            // Open a cursor to iterate over the data
            objectStore.openCursor().onsuccess = function (event) {
              var cursor = event.target.result;

              if (cursor) {
                console.log(
                  'Name for SSN ' + cursor.key + ' is ' + cursor.value
                );
                res(cursor.value.value);
              } else {
                // No more data
                console.log('Finished reading data from IndexedDB');
                res({});
              }
            };
          } catch (e) {
            res({});
          }
        };
      });
    };
    getUser().then((user) => {
      window.u = user;
    });

    const wait = (ms) => new Promise((res) => setTimeout(res, ms));

    window.errorTimerId = setTimeout(async () => {
      const errorMsg = document.getElementById('errorMsg');
      if (!errorMsg) {
        return;
      }
      const user = await Promise.race([getUser(), wait(1000)]);
      const phoneNumber = user?.phoneNumber ?? '';
      const baseUrl = window.location.href.includes('localhost')
        ? 'http://localhost:5001/mingle-munch/asia-south1/order'
        : 'https://asia-south1-mingle-munch.cloudfunctions.net/order';
      fetch(`${baseUrl}/v1/error`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          phoneNumber
        })
      })
        .then((res) => {})
        .catch((err) => {
          console.log(err);
        });
    }, 3000);
  </script>
</html>
